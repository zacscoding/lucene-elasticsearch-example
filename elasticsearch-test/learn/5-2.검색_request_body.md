
### 5.3 리퀘스트 바디 검색

- JSON 데이터 형식의 질의로 입력해서 사용 가능
- 리퀘스트 바디(Request Body) 검색 (URI보다 복잡한 검색 가능)
- QueryDSL를 사용(term,match,range 등 다양한 질의가 존재)

<pre>
&lt;호스트&gt;:&lt;포트&gt;/&lt;?인덱스&gt;/&lt;?타입&gt;/_search -d '
{
  &gt;옵션&gt; : &gt;값&gt;, ...
  "query" : {
    ... &gt;질의 문법&gt; ...,
  }
}
'
</pre>

> term query (books인덱스에서 author가 william인 값을 검색)

<pre>
[root@localhost ~]# curl 'localhost:9200/books/_search?pretty' -d '
{
	"query" : {
		"term" : {"author" : "william"}
	}
}'
{
  "took" : 2,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "failed" : 0
  },
  "hits" : {
    "total" : 6,
    ...
}
</pre>

---

#### 5.3.1 size, from, fields

> 전체 인덱스에서 from : 1 , size : 2, fields : ["title","category"]

<pre>
[root@localhost ~]# curl 'localhost:9200/_search?pretty' -d '
{
	from : 1,
	size : 2,
	fields : ["title","category"],
	"query" : {
		"term" : {"_all" : "time"}
	}
}'
{
  "took" : 47,
  "timed_out" : false,
  "_shards" : {
    "total" : 10,
    "successful" : 10,
    "failed" : 0
  },
  "hits" : {
    "total" : 6,
    "max_score" : 0.20909351,
    "hits" : [ {
      "_index" : "magazines",
      "_type" : "magazine",
      "_id" : "AV3bYRmjZzdBqJ5zrYAD",
      "_score" : 0.13561106,
      "fields" : {
        "title" : [ "Time" ],
        "category" : [ "News magazine" ]
      }
    }, {
      "_index" : "books",
      "_type" : "book",
      "_id" : "AV3bYAfGZzdBqJ5zrYAB",
      "_score" : 0.13258252,
      "fields" : {
        "title" : [ "Around the World in Eighty Days" ],
        "category" : [ "adventure novel" ]
      }
    } ]
  }
}
</pre>


---

#### 5.3.2 sort
- 기본적으로 검색 결과의 출력은 _score 값을 기준으로 정렬
- 배열로 정렬할 필드를 여러 개 지정할 수 있음

> category-desc , pages&title - asc

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/books/_search?pretty' -d '{
  "fields" : ["title","author","category","pages"],
  "sort" : [{"category":"desc"}, "pages", "title"],
  "query" : {
    "term" : {"_all" : "time"}
  }
}'
{
  "took" : 7,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "failed" : 0
  },
  "hits" : {
    "total" : 4,
    "max_score" : null,
    "hits" : [ {      
      ...
      "sort" : [ "science", 210, "invisible" ]
    }, {
      ...
      "sort" : [ "science", 227, "machine" ]
    }, {
      ...
      "sort" : [ "science", 304, "leagues" ]
    }, {
      ...
      "sort" : [ "novel", 189, "around" ]
    } ]
  }
}
</pre>

**order 필드로 오름/내림 차순 가능**  

- min  
  : 해당 필드의 값 중 최소값을 선택
- max  
  : 해당 필드의 값 중 최대값을 선택
- avg  
  : 해당 필드 값의 평균값을 대입. 필드 값이 number 일때만 유효
- sum  
  : 해당 필드 값의 합계를 대입. 필드 값이 number 일때만 유효



> category 필드의 sort 값을 mode: min, max로 각각 검색  

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/books/_search?pretty' -d '
{
 "fields" : ["title","author","category","pages"],
 "sort" : [{"category":{"order":"desc", "mode" :"min"}},"pages", "title"],
 "query" : {
   "term" : {"category" : "science"}
 }
}'
...  
      "fields" : {
        "pages" : [ 210 ],
        "title" : [ "The Invisible Man" ],
        "category" : [ "Horror", "Science fiction novel" ],
        "author" : [ "H. G. Wells" ]
      },
      "sort" : [ "fiction", 210, "invisible" ]
    },
      ....
      "sort" : [ "fiction", 227, "machine" ]
    },
      ...
      "sort" : [ "adventure", 212, "center" ]
    },
      ...
      "sort" : [ "adventure", 304, "leagues" ]
    } ]
  }
}
</pre>

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/books/_search?pretty' -d '
{
 "fields" : ["title","author","category","pages"],
 "sort" : [{"category":{"order":"desc", "mode" :"max"}},"pages", "title"],
 "query" : {
   "term" : {"category" : "science"}
 }
}'
      ...
      "sort" : [ "science", 210, "invisible" ]
    },
      ...
      "sort" : [ "science", 212, "center" ]
    },
      ...
      "sort" : [ "science", 227, "machine" ]
    },
      ...
      "sort" : [ "science", 304, "leagues" ]
    } ]
  }
}
</pre>

=> category 필드 값이 "Horror", "Science fiction novel" 중
- "fiction" : 가장 낮은 값 (min)
- "science" : 가장 높은 값 (max)

> fail [unmapped : author in magazines]

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/_search?pretty' -d '
{
 "fields" : ["title","author","category"],
 "sort" : ["title","author"],
 "query" : {
   "term" : {"title" : "time"}
 }
}'
{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 10,
    "successful" : 5,
    "failed" : 5,     // 실패5 (author가 존재X)
    "failures" : [ {
      "shard" : 0,
      "index" : "magazines",
      "node" : "dFOmM-4qQDqR2kDeK_ytrg",
      "reason" : {
        "type" : "search_parse_exception",
        "reason" : "No mapping found for [author] in order to sort on"
      }
    } ]
  },
  "hits" : {
    "total" : 1,
    "max_score" : null,
    "hits" : [ {
      "_index" : "books",
      "_type" : "book",
      "_id" : "AV3cEb_p05FddoLcsPSg",
      "_score" : null,
      "fields" : {
        "title" : [ "The Time Machine" ],
        "category" : [ "Science fiction novel" ],
        "author" : [ "H. G. Wells" ]
      },
      "sort" : [ "machine", "g" ]
    } ]
  }
}
</pre>

> ignore_unmapped

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/_search?pretty' -d '
{
 "fields" : ["title","author","category"],
 "sort" : ["title",{"author":{"ignore_unmapped":true}}],
 "query" : {
   "term" : {"title" : "time"}
 }
}'
{
  "took" : 7,
  "timed_out" : false,
  "_shards" : {
    "total" : 10,
    "successful" : 10,
    "failed" : 0        // 실패 0
  },
  "hits" : {
    "total" : 2,
    "max_score" : null,
    "hits" : [ {
      "_index" : "books",
      "_type" : "book",
      "_id" : "AV3cEb_p05FddoLcsPSg",
      "_score" : null,
      "fields" : {
        "title" : [ "The Time Machine" ],
        "category" : [ "Science fiction novel" ],
        "author" : [ "H. G. Wells" ]
      },
      "sort" : [ "machine", "g" ]
    }, {
      "_index" : "magazines",
      "_type" : "magazine",
      "_id" : "AV3cEfDg05FddoLcsPSm",
      "_score" : null,
      "fields" : {
        "title" : [ "Time" ],
        "category" : [ "News magazine" ]
      },
      "sort" : [ "time", 9223372036854775807 ]
    } ]
  }
}
</pre>

> track_scores 점수 표시

<pre>
[root@localhost elasticsearch-2.4.4]# curl 'localhost:9200/books/_search?pretty' -d '
{
 "fields" : ["title","author","category"],
 "sort" : ["title",{"author":{"ignore_unmapped":true}}],
 "track_scores": true,
 "query" : {
   "term" : {"title" : "time"}
 }
}'
{
  "took" : 5,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "failed" : 0
  },
  "hits" : {
    "total" : 1,
    "max_score" : 0.8465736,
    "hits" : [ {
      "_index" : "books",
      "_type" : "book",
      "_id" : "AV3cEb_p05FddoLcsPSg",
      "_score" : 0.8465736, //점수 표기
      "fields" : {
        "title" : [ "The Time Machine" ],
        "category" : [ "Science fiction novel" ],
        "author" : [ "H. G. Wells" ]
      },
      "sort" : [ "machine", "g" ]
    } ]
  }
}
</pre>

---

#### 5.3.3 _source

































































<br /><br /><br /><br /><br />
q
